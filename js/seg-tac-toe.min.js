/*

  Seg-Tac-Toe
    by John "Seg" Seggerson
    http://theseg.github.io/

*/

var playField = {
    "width":3,
    "height":3,
	"winLength":3,
	"coreCellIDName":"stt-main-cell-",
	"winConditions": [
		{
			"winAnimationClass":"winCondition-diag-00",
			"cells":[
				{"x":0,"y":0},
				{"x":1,"y":1},
				{"x":2,"y":2},
			],
		},
		{
			"winAnimationClass":"winCondition-diag-01",
			"cells":[
				{"x":0,"y":2},
				{"x":1,"y":1},
				{"x":2,"y":0},
			],
		},
		{
			"winAnimationClass":"winCondition-hor-00",
			"cells":[
				{"x":0,"y":0},
				{"x":0,"y":1},
				{"x":0,"y":2},
			],
		},
		{
			"winAnimationClass":"winCondition-hor-01",
			"cells":[
				{"x":1,"y":0},
				{"x":1,"y":1},
				{"x":1,"y":2},
			],
		},
		{
			"winAnimationClass":"winCondition-hor-02",
			"cells":[
				{"x":2,"y":0},
				{"x":2,"y":1},
				{"x":2,"y":2},
			],
		},
		{
			"winAnimationClass":"winCondition-ver-00",
			"cells":[
				{"x":0,"y":0},
				{"x":1,"y":0},
				{"x":2,"y":0},
			],
		},
		{
			"winAnimationClass":"winCondition-ver-01",
			"cells":[
				{"x":0,"y":1},
				{"x":1,"y":1},
				{"x":2,"y":1},
			],
		},
		{
			"winAnimationClass":"winCondition-ver-02",
			"cells":[
				{"x":0,"y":2},
				{"x":1,"y":2},
				{"x":2,"y":2},
			],
		},
	],
};

var gamePlayStatusTypes = {
	"inprogress":0,
	"winner":1,
	"draw":2,
};

var players = ["X","O"];

var playerProps = {
    "X": {
        "shortname": "X",
        "faIconClass": "icon-remove-circle",
		"cellClass": "input-claimed-x",
    },
    "O": {
        "shortname": "O",
        "faIconClass": "icon-circle-blank",
		"cellClass": "input-claimed-o",
    }
};

var initalStatus = {
	"currentPlayer":"X",
	"state":gamePlayStatusTypes.inprogress,
	"winner":null,
	"winCondition":null,
};

var currentStatus = initalStatus;

function sttResetVars() {
	currentStatus = initalStatus;
}

function sttInitVars() {
	sttResetVars();
}


/* **********************************************
     Begin stt-ui.js
********************************************** */

/*

  Seg-Tac-Toe
    by John "Seg" Seggerson
    http://theseg.github.io/

*/

var targetMarkCellClasses;

function sttInitUI()
{
	console.log("sttInitUI();");
	targetMarkCellClasses = [
		"input-claimed"
	];
	for ( var playerName in playerProps ) {
		targetMarkCellClasses.push( playerProps[playerName].cellClass );
	}
}

function sttResetUI()
{
	console.log("sttResetUI();");
	
}

function sttUIMarkcell( targetCell , targetPlayer )
{
	// Check to make sure square isn't already assigned.
	if ( targetCell.hasClass("input-claimed") === false ) {
		// Assign player's CSS class to target element.
		targetCell.addClass( "input-claimed " + playerProps[targetPlayer].cellClass);
	} else {
		console.warn( "The cell '"+targetCell.id+"' is already claimed!" );
	}
}

function sttUIUnMarkCell( targetCell )
{
	targetCell.removeClass( targetMarkCellClasses.join(" ") );
}

function sttUIUnMarkCellAll()
{
	$(".stt-cell").each(function(i,a) {
		sttUIUnMarkCell( $(this) );
	});
}

/* **********************************************
     Begin stt-input.js
********************************************** */

/*

  Seg-Tac-Toe
    by John "Seg" Seggerson
    http://theseg.github.io/

*/

// Variables


// Global functions
function sttInitInput()
{
	$(".stt-cell").click( function() {
		sttInputBind( this );
	});
}

function sttResetInput()
{
	
}

function sttInputAdvancePlayer()
{
	
	var nextIndex = ( $.inArray( currentStatus.currentPlayer , players ) + 1 );
	if ( nextIndex < 0 ) {
		console.error( "Players array is incorrect.", "sttInputAdvancePlayer();");
	} else if ( nextIndex >= players.length ) {
		currentStatus.currentPlayer = players[0];
	} else {
		currentStatus.currentPlayer = players[ nextIndex ];
	}
	
}

function sttInputEndTurn() {
	sttSetWinStatus();
}

function sttInputBind( targetElement ) {
	
	if ( currentStatus.state === gamePlayStatusTypes.inprogress ) {
		sttUIMarkcell( $(targetElement) , currentStatus.currentPlayer );
		sttInputAdvancePlayer();
		sttInputEndTurn();
	}
	
}


/* **********************************************
     Begin stt-logic.js
********************************************** */

/*

  Seg-Tac-Toe
    by John "Seg" Seggerson
    http://theseg.github.io/

*/


function sttResetLogic()
{
	
}

function sttInitLogic()
{
	
}

function sttCellXYtoID( inputXY )
{
	return playField.coreCellIDName + inputXY.x + "-" + inputXY.y;
}

function sttGetRowStatus( targetID )
{
	// Variable declars
	var returnVar = {
		"state":gamePlayStatusTypes.inprogress,
		"winner":null,
		"winCondition":null,
	};
	var targetPlayer = null;
	var targetElement = $(targetID);
	
	// What player are we looking at?
	for ( var targetClass in playerProps ) {
		if ( targetElement.hasClass(playerProps[targetClass].cellClass) ) {
			targetPlayer = targetClass;
		}
	}
	
	if ( targetPlayer !== null ) {
		for ( var targetCondition in playField.winConditions ) {
			var cellCount = 0;
			for ( var targetCell in playField.winConditions[targetCondition].cells ) {
				var targetXY = playField.winConditions[targetCondition].cells[targetCell];
				var targetStatus = $( "#"+sttCellXYtoID( targetXY ) ).hasClass( playerProps[targetPlayer].cellClass );
				if ( targetStatus === true ) {
					cellCount++;
				}
			}
			if ( cellCount >= playField.winLength ) {
				// PLAYER HAS WON!
				returnVar.state = gamePlayStatusTypes.winner;
				returnVar.winner = targetPlayer;
				returnVar.winCondition = targetCondition;
				break;
			}
		}
		
	} else {
		// Unclaimed square;
		returnVar.state = gamePlayStatusTypes.inprogress;
		returnVar.winner = null;
	}
	
	return returnVar;
	
}

function sttSetWinStatus()
{
	
	// Variable declars
	var doEval = false;
	var returnVar = {
		"state":0,
		"winner":null,
		"winCondition":null,
	};
	var playerSquares = {};
	
	// Does any one player have more than three owned squares? If so, we can eval.
	for ( var targetPlayer in playerProps ) {
		// Grab the claimed cells for each player.
		playerSquares[targetPlayer] = $("."+playerProps[targetPlayer].cellClass);
		
		// Check if there's at least enough claimed squares for evaluation.
		if ( playerSquares[targetPlayer].length >= playField.winLength ) {
			doEval = true;
		}
	}
	
	// May we evaluate?
	if ( doEval === true ) {
		// Cycle though each claimed cell to see if we have a row.
		for ( var targetPlayerCells in playerSquares ) {
			for ( var targetCell=0; targetCell < playerSquares[targetPlayerCells].length; targetCell++ ) {
				var returnRowStatus = sttGetRowStatus( playerSquares[targetPlayerCells][targetCell] );
				if ( returnRowStatus.state !== gamePlayStatusTypes.inprogress ) {
					returnVar = returnRowStatus;
					break;
				}
			}
			if ( returnVar.state !== gamePlayStatusTypes.inprogress ) {
				break;
			}
		}
		
	} else {
		// The defacto returnVar of 0:null state is already defined.
	}
	
	currentStatus.state = returnVar.state;
	currentStatus.winner = returnVar.winner;
	currentStatus.winCondition = returnVar.winCondition;
	
	return true;
}

function sttGameStateToString()
{
	// Variable declars
	var returnString;
	
	// Set Global current status
	sttSetWinStatus();
	
	// Respond back with string of status.
	switch( currentStatus.state )
	{
		case 0:
			returnString = "Game is still in progress.";
			break;
		case 1:
			returnString = "Game was won by player "+currentStatus.winner+" with the #"+currentStatus.winCondition+" win condition!";
			break;
		case 2:
			returnString = "Game has ended in a draw.";
			break;
		default:
			returnString = "Game is still in progress.";
	}
	
	return returnString;
}


/* **********************************************
     Begin seg-tac-toe.js
********************************************** */

/*

  Seg-Tac-Toe
    by John "Seg" Seggerson
    http://theseg.github.io/

*/

// @codekit-prepend "stt-vars.js";
// @codekit-prepend "stt-ui.js";
// @codekit-prepend "stt-input.js";
// @codekit-prepend "stt-logic.js";


function sttInit() {
	sttInitVars();
	sttInitLogic();
	sttInitUI();
	sttInitInput();
}

function sttReset() {
	sttResetVars();
	sttResetLogic();
	sttResetUI();
	sttResetInput();
}

$( document ).ready(function() {
    console.log("document.ready");
	
	sttInit();
	
	// Use to quickly set given situation.
	if ( false ) {
		sttUIMarkcell($("#stt-main-cell-0-0"),"X");
		sttUIMarkcell($("#stt-main-cell-1-1"),"O");
		sttUIMarkcell($("#stt-main-cell-0-1"),"X");
		sttUIMarkcell($("#stt-main-cell-2-0"),"O");
		sttUIMarkcell($("#stt-main-cell-0-2"),"X");
		//sttUIMarkcell($("#stt-main-cell-0-2"),"O");
	} else if ( false ) {
		sttUIMarkcell($("#stt-main-cell-0-0"),"X");
		sttUIMarkcell($("#stt-main-cell-0-1"),"O");
		sttUIMarkcell($("#stt-main-cell-1-1"),"X");
		sttUIMarkcell($("#stt-main-cell-2-0"),"O");
		sttUIMarkcell($("#stt-main-cell-1-2"),"X");
		sttUIMarkcell($("#stt-main-cell-0-2"),"O");
	}

});
